
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Completion Checks &#8212; libcasm-monte 2.2.0 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../_static/css/custom.css?v=1d1c7082" />
  
  <!-- So that users can add custom icons -->
  <script src="../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../_static/documentation_options.js?v=b21de401"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'usage/completion_check';</script>
    <link rel="icon" href="../_static/favicon-16x16.png"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Reference (libcasm)" href="../reference/libcasm/index.html" />
    <link rel="prev" title="Overview" href="overview.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="2.2" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/small_logo.svg" class="logo__image only-light" alt=""/>
    <img src="../_static/small_logo_dark.svg" class="logo__image only-dark pst-js-only" alt=""/>
  
  
    <p class="title logo__title">libcasm-monte</p>
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../installation.html">
    Installation
  </a>
</li>


<li class="nav-item current active">
  <a class="nav-link nav-internal" href="../usage.html">
    Usage
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../reference/libcasm/index.html">
    Reference
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../bibliography.html">
    Bibliography
  </a>
</li>

  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
        </div>
      
      
        <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/prisms-center/CASMcode_monte/" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://pypi.org/project/libcasm-monte/" title="PyPI" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-python fa-lg" aria-hidden="true"></i>
            <span class="sr-only">PyPI</span></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
    </div>
  

  
    <button class="pst-navbar-icon sidebar-toggle secondary-toggle" aria-label="On this page">
      <span class="fa-solid fa-outdent"></span>
    </button>
  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../installation.html">
    Installation
  </a>
</li>


<li class="nav-item current active">
  <a class="nav-link nav-internal" href="../usage.html">
    Usage
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../reference/libcasm/index.html">
    Reference
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../bibliography.html">
    Bibliography
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/prisms-center/CASMcode_monte/" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://pypi.org/project/libcasm-monte/" title="PyPI" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-python fa-lg" aria-hidden="true"></i>
            <span class="sr-only">PyPI</span></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
<nav class="bd-docs-nav bd-links"
     aria-label="Section Navigation">
  <p class="bd-links__title" role="heading" aria-level="1">Section Navigation</p>
  <div class="bd-toc-item navbar-nav"><ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="overview.html">Overview</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Completion Checks</a></li>
</ul>
</div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../usage.html" class="nav-link">Usage</a></li>
    
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">Completion Checks</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="completion-checks">
<h1>Completion Checks<a class="headerlink" href="#completion-checks" title="Link to this heading">#</a></h1>
<p>The <code class="xref py py-class docutils literal notranslate"><span class="pre">CompletionCheck</span></code> class can be used to check when a Monte Carlo simulation is complete. It is constructed with a <code class="xref py py-class docutils literal notranslate"><span class="pre">CompletionCheckParams</span></code> instance which allows:</p>
<ul class="simple">
<li><p>setting the requested absolute or relative precision for convergence of sampled data</p></li>
<li><p>setting cutoff parameters for number of steps or passes, number of samples, amount of simulated time
or amount of elapsed clocktime, with:</p>
<ul>
<li><p>minimums, which force the simulation to keep running until a minimium value is reached</p></li>
<li><p>maximums, which force the simulation to stop running when a maximum value is reached</p></li>
</ul>
</li>
<li><p>controlling when completion checks are performed</p></li>
<li><p>customizing the method used to check for equilibration</p></li>
<li><p>customizing the method used to calculate statistics</p></li>
</ul>
<p>A <code class="xref py py-class docutils literal notranslate"><span class="pre">CompletionCheckParams</span></code> instance can be read from a Python dict for input file parsing.</p>
<section id="performing-completion-checks">
<h2>Performing completion checks<a class="headerlink" href="#performing-completion-checks" title="Link to this heading">#</a></h2>
<p>Example usage:</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">libcasm.monte</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">monte</span>

<span class="c1"># ~~~ Initialize a random number engine ~~~</span>
<span class="n">random_number_engine</span> <span class="o">=</span> <span class="n">monte</span><span class="o">.</span><span class="n">RandomNumberEngine</span><span class="p">()</span>

<span class="c1"># ~~~ User input: Specify the system ~~~</span>
<span class="c1"># For example, the prim, cluster expansions, composition axes, etc.</span>
<span class="n">prim</span> <span class="o">=</span> <span class="o">...</span>
<span class="n">composition_axes</span> <span class="o">=</span> <span class="o">...</span>
<span class="n">formation_energy_clexulator</span> <span class="o">=</span> <span class="o">...</span>
<span class="n">formation_energy_coeff</span> <span class="o">=</span> <span class="o">...</span>

<span class="c1"># ~~~ Construct the system ~~~</span>
<span class="c1"># Construct a data structure that makes system data accessible</span>
<span class="c1"># to the Monte Carlo calculator and sampling functions</span>
<span class="n">system</span> <span class="o">=</span> <span class="n">SystemType</span><span class="p">(</span>
    <span class="n">prim</span><span class="o">=</span><span class="n">prim</span><span class="p">,</span>
    <span class="n">composition_axes</span><span class="o">=</span><span class="n">composition_axes</span><span class="p">,</span>
    <span class="n">formation_energy_clexulator</span><span class="o">=</span><span class="n">formation_energy_clex_clexulator</span><span class="p">,</span>
    <span class="n">formation_energy_coeff</span><span class="o">=</span><span class="n">formation_energy_clex_coeff</span><span class="p">,</span>
    <span class="o">...</span>
<span class="p">)</span>

<span class="c1"># ~~~ Construct the Monte Carlo calculator ~~~</span>
<span class="c1"># A Monte Carlo calculator implements the Monte Carlo method and holds</span>
<span class="c1"># method specific data along with access to the system.</span>
<span class="c1"># For example, this would have the current configuration and conditions</span>
<span class="n">mc_calculator</span> <span class="o">=</span> <span class="n">MonteCarloCalculatorType</span><span class="p">(</span>
    <span class="n">system</span><span class="p">,</span>
    <span class="n">random_number_engine</span><span class="p">,</span>
    <span class="o">...</span>
<span class="p">)</span>

<span class="c1"># ~~~ Construct sampling functions ~~~</span>
<span class="c1"># Sampling functions should be given access to the mc_calculator to</span>
<span class="c1"># be able to take samples when called, and stored in a StateSamplingFunctionMap</span>
<span class="n">sampling_functions</span> <span class="o">=</span> <span class="n">monte</span><span class="o">.</span><span class="n">StateSamplingFunctionMap</span><span class="p">()</span>
<span class="n">_functions</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">make_formation_energy_f</span><span class="p">(</span><span class="n">mc_calculator</span><span class="p">),</span>
    <span class="n">make_potential_energy_f</span><span class="p">(</span><span class="n">mc_calculator</span><span class="p">),</span>
    <span class="n">make_parametric_composition_f</span><span class="p">(</span><span class="n">mc_calculator</span><span class="p">),</span>
<span class="p">]</span>
<span class="k">for</span> <span class="n">_f</span> <span class="ow">in</span> <span class="n">_functions</span><span class="p">:</span>
    <span class="n">sampling_functions</span><span class="p">[</span><span class="n">_f</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">_f</span>

<span class="c1"># ~~~ User input: Set CompletionCheckParams ~~~</span>
<span class="n">params</span> <span class="o">=</span> <span class="n">monte</span><span class="o">.</span><span class="n">CompletionCheckParams</span><span class="p">()</span>
<span class="n">params</span><span class="o">.</span><span class="n">cutoff_params</span><span class="o">.</span><span class="n">max_count</span> <span class="o">=</span> <span class="mi">100</span>

<span class="n">completion_check</span> <span class="o">=</span> <span class="n">monte</span><span class="o">.</span><span class="n">CompletionCheck</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

<span class="c1"># ~~~ User input: Specify quantities to be sampled ~~~</span>
<span class="c1"># should be keys into sampling_functions</span>
<span class="n">quantities</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;formation_energy&quot;</span><span class="p">,</span>
    <span class="s2">&quot;potential_energy&quot;</span><span class="p">,</span>
    <span class="s2">&quot;parametric_composition&quot;</span><span class="p">,</span>
<span class="p">]</span>

<span class="c1"># ~~~ Construct data samplers - for all requested quantities ~~~</span>
<span class="n">samplers</span> <span class="o">=</span> <span class="n">monte</span><span class="o">.</span><span class="n">SamplerMap</span><span class="p">()</span>
<span class="k">for</span> <span class="n">quantity_name</span> <span class="ow">in</span> <span class="n">quantities</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">quantity_name</span> <span class="ow">in</span> <span class="n">sampling_functions</span><span class="p">:</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">sampling_functions</span><span class="p">[</span><span class="n">quantity_name</span><span class="p">]</span>
        <span class="n">samplers</span><span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">monte</span><span class="o">.</span><span class="n">Sampler</span><span class="p">(</span>
            <span class="n">shape</span><span class="o">=</span><span class="n">f</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
            <span class="n">component_names</span><span class="o">=</span><span class="n">f</span><span class="o">.</span><span class="n">component_names</span><span class="p">,</span>
        <span class="p">)</span>

<span class="c1"># this is required, but can be left with 0 samples to indicate unweighted</span>
<span class="n">sample_weight</span> <span class="o">=</span> <span class="n">monte</span><span class="o">.</span><span class="n">Sampler</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">[])</span>

<span class="c1"># method log specifies where to periodically write status messages</span>
<span class="c1"># internally, method log tracks the elapsed clock time</span>
<span class="n">method_log</span> <span class="o">=</span> <span class="n">monte</span><span class="o">.</span><span class="n">MethodLog</span><span class="p">(</span><span class="n">path_to_logfile</span><span class="p">)</span>

<span class="n">n_steps</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">i_sample_period</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">sample_period</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="k">while</span> <span class="ow">not</span> <span class="n">completion_check</span><span class="o">.</span><span class="n">count_check</span><span class="p">(</span>
    <span class="n">samplers</span><span class="o">=</span><span class="n">samplers</span><span class="p">,</span>
    <span class="n">sample_weight</span><span class="o">=</span><span class="n">sample_weight</span><span class="p">,</span>
    <span class="n">count</span><span class="o">=</span><span class="n">n_steps</span><span class="p">,</span>
    <span class="n">method_log</span><span class="o">=</span><span class="n">method_log</span><span class="p">,</span>
<span class="p">):</span>
    <span class="c1"># ... do Monte Carlo step ...</span>
    <span class="n">n_steps</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1"># ... periodically sample data ...</span>
    <span class="k">if</span> <span class="n">i_sample_period</span> <span class="o">==</span> <span class="n">sample_period</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">sampling_functions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">samplers</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">())</span>
</pre></div>
</div>
</section>
<section id="examples">
<h2>Examples<a class="headerlink" href="#examples" title="Link to this heading">#</a></h2>
<p>Run for a user-specified number of steps:</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">libcasm.monte</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">monte</span>
<span class="n">params</span> <span class="o">=</span> <span class="n">monte</span><span class="o">.</span><span class="n">CompletionCheckParams</span><span class="p">()</span>
<span class="n">params</span><span class="o">.</span><span class="n">cutoff_params</span><span class="o">.</span><span class="n">max_count</span> <span class="o">=</span> <span class="mi">100</span>

<span class="n">completion_check</span> <span class="o">=</span> <span class="n">monte</span><span class="o">.</span><span class="n">CompletionCheck</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

<span class="n">n_steps</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">while</span> <span class="ow">not</span> <span class="n">completion_check</span><span class="o">.</span><span class="n">count_check</span><span class="p">(</span>
    <span class="n">samplers</span><span class="o">=</span><span class="n">samplers</span><span class="p">,</span>
    <span class="n">sample_weight</span><span class="o">=</span><span class="n">sample_weight</span><span class="p">,</span>
    <span class="n">count</span><span class="o">=</span><span class="n">n_steps</span><span class="p">,</span>
    <span class="n">method_log</span><span class="o">=</span><span class="n">method_log</span><span class="p">,</span>
<span class="p">):</span>
    <span class="c1"># ... do Monte Carlo step ...</span>
    <span class="n">n_steps</span> <span class="o">+=</span> <span class="mi">1</span>
</pre></div>
</div>
<p>Set a limit for the maximum elapsed clock time (in seconds):</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Because checking the clock time at every Monte Carlo step slows down calculations excessively, clock time limits are only checked after the number of samples changes, and the actual clock time at which a simulation is stopped may longer than the limit set.</p>
</div>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">libcasm.monte</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">monte</span>
<span class="n">params</span> <span class="o">=</span> <span class="n">monte</span><span class="o">.</span><span class="n">CompletionCheckParams</span><span class="p">()</span>
<span class="n">params</span><span class="o">.</span><span class="n">cutoff_params</span><span class="o">.</span><span class="n">max_count</span> <span class="o">=</span> <span class="mf">3.6e2</span> <span class="c1"># stop after running at least 1 hr</span>

<span class="n">completion_check</span> <span class="o">=</span> <span class="n">monte</span><span class="o">.</span><span class="n">CompletionCheck</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

<span class="n">n_steps</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">while</span> <span class="ow">not</span> <span class="n">completion_check</span><span class="o">.</span><span class="n">count_check</span><span class="p">(</span>
    <span class="n">samplers</span><span class="o">=</span><span class="n">samplers</span><span class="p">,</span>
    <span class="n">sample_weight</span><span class="o">=</span><span class="n">sample_weight</span><span class="p">,</span>
    <span class="n">count</span><span class="o">=</span><span class="n">n_steps</span><span class="p">,</span>
    <span class="n">method_log</span><span class="o">=</span><span class="n">method_log</span><span class="p">,</span>
<span class="p">):</span>
    <span class="c1"># ... do Monte Carlo step ...</span>
    <span class="n">n_steps</span> <span class="o">+=</span> <span class="mi">1</span>
</pre></div>
</div>
<p>The ensemble average value of a property can be estimated from Metropolis Monte Carlo simulations as</p>
<div class="math notranslate nohighlight">
\[\langle X \rangle \approx \bar{X} = \frac{\sum_l^N X_l}{N},\]</div>
<p>where:</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(X_l\)</span> is the <span class="math notranslate nohighlight">\(l\)</span>-th of <span class="math notranslate nohighlight">\(N\)</span> observations of property <span class="math notranslate nohighlight">\(X\)</span></p></li>
<li><p><span class="math notranslate nohighlight">\(\langle X \rangle\)</span> is the ensemble average</p></li>
<li><p><span class="math notranslate nohighlight">\(\bar{X}\)</span> is the mean of the observations.</p></li>
</ul>
<p>The error, <span class="math notranslate nohighlight">\(\bar{X} - \langle X \rangle\)</span>, is normally distributed and approaches zero in the limit of large <span class="math notranslate nohighlight">\(N\)</span> according to the central limit theorem,</p>
<div class="math notranslate nohighlight">
\[\bar{X}-\langle X \rangle \approx \mathcal{N}(0, \sigma^2/N).\]</div>
<p>For stationary distributions, the variance of the error, <span class="math notranslate nohighlight">\(\sigma^2\)</span>, can be calculated from the lag <span class="math notranslate nohighlight">\(k\)</span> autocovariance between observations <span class="math notranslate nohighlight">\(X_j\)</span> and <span class="math notranslate nohighlight">\(X_{j+k}\)</span>  as</p>
<div class="math notranslate nohighlight">
\[ \begin{align}\begin{aligned}\sigma^2 = \gamma_0 + 2 \sum^\infty_{k=1} \gamma_k,\\\gamma_k = \mathrm{Cov}\left( X_j, X_{j+k} \right).\end{aligned}\end{align} \]</div>
<p>After an initial equilibration period, samples drawn from Monte Carlo simulations have a stationary distribution. Therefore, the error can be estimated from the observations by estimating <span class="math notranslate nohighlight">\(\sum^\infty_{k=1} \gamma_k\)</span>.</p>
<p>If the autocovariance decays like <span class="math notranslate nohighlight">\(\gamma_k = \gamma_0 \rho^{-|k|}\)</span>, then the infinite sum can be evaluated to give</p>
<div class="math notranslate nohighlight">
\[\sigma^2 = \gamma_0 \left(\frac{1+\rho}{1-\rho}\right).\]</div>
<p>Van de Walle and Asta introduced methods for determining the initial equilibration period from which observations should be discarded before calculating the mean, and for calculating <span class="math notranslate nohighlight">\(\rho\)</span> from the remaining observations to estimate the error in the mean. These methods are implemented in CASM in the <code class="xref py py-func docutils literal notranslate"><span class="pre">default_equilibration_check()</span></code> and <code class="xref py py-class docutils literal notranslate"><span class="pre">BasicStatisticsCalculator</span></code> methods, respectively, and used as the defaults for automatic convergence to user-specified precision.</p>
<p>Users may also implement and use alternative methods through the <cite>equilibration_check_f</cite> and <cite>calc_statistics_f</cite> parameters of the <code class="xref py py-class docutils literal notranslate"><span class="pre">CompletionCheckParams</span></code> class.</p>
</section>
<section id="equilibration-check">
<h2>Equilibration check<a class="headerlink" href="#equilibration-check" title="Link to this heading">#</a></h2>
<p>The <code class="xref py py-func docutils literal notranslate"><span class="pre">default_equilibration_check()</span></code> method partitions an array of
observations into three ranges:</p>
<ul class="simple">
<li><p>the equilibriation stage, <code class="docutils literal notranslate"><span class="pre">[0,</span> <span class="pre">start1)</span></code>,</p></li>
<li><p>the first partition, <code class="docutils literal notranslate"><span class="pre">[start1,</span> <span class="pre">start2)</span></code>,</p></li>
<li><p>and the second partition, <code class="docutils literal notranslate"><span class="pre">[start2,</span> <span class="pre">N)</span></code>,</p></li>
</ul>
<p>where <cite>N</cite> is <code class="docutils literal notranslate"><span class="pre">len(observations)</span></code>, and <cite>start1</cite> and <cite>start2</cite> are indices into
the observations array such that <code class="docutils literal notranslate"><span class="pre">0</span> <span class="pre">&lt;=</span> <span class="pre">start1</span> <span class="pre">&lt;</span> <span class="pre">start2</span> <span class="pre">&lt;=</span> <span class="pre">N</span></code>, and the number
of elements in the first and second partition are the same (within 1).</p>
<p>The simulation is considered equilibrated at observation <cite>start1</cite> if the
mean of the elements in the first and second partition are approximately equal
to the desired precsion, <code class="docutils literal notranslate"><span class="pre">(abs(mean1</span> <span class="pre">-</span> <span class="pre">mean2)</span> <span class="pre">&lt;</span> <span class="pre">prec)</span></code>.</p>
<p>Additionally, in CASM, the value <cite>start1</cite> is incremented as much as needed to ensure
that the equilibration stage has observations on either side of the overall mean.</p>
<p>The result of <code class="xref py py-func docutils literal notranslate"><span class="pre">default_equilibration_check()</span></code> is of type <code class="xref py py-class docutils literal notranslate"><span class="pre">IndividualEquilibrationResult</span></code>, which has two attributes which are set as follows:</p>
<ul class="simple">
<li><p>If all observations are approximately equal, then:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">is_equilibrated</span> <span class="pre">=</span> <span class="pre">True</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">N_samples_for_equilibration</span> <span class="pre">=</span> <span class="pre">0</span></code></p></li>
</ul>
</li>
<li><p>If the equilibration conditions are met, the result contains:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">is_equilibrated</span> <span class="pre">=</span> <span class="pre">true</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">N_samples_for_equilibration</span> <span class="pre">=</span> <span class="pre">start1</span></code></p></li>
</ul>
</li>
<li><p>If the equilibration conditions are not met, the result contains:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">is_equilibrated</span> <span class="pre">=</span> <span class="pre">false</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">N_samples_for_equilibration</span> <span class="pre">=</span> <span class="pre">&lt;undefined&gt;</span></code></p></li>
</ul>
</li>
</ul>
<p>If samples are weighted, as in the n-fold way algorithm, then the same
partitioning method is used, but with weighted observations calculated using:</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">weighted_observation</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sample_weight</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">observation</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">N</span> <span class="o">/</span> <span class="n">W</span>
</pre></div>
</div>
<p>where:</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">W</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">sample_weight</span><span class="p">)</span>
</pre></div>
</div>
<p>The same weight_factor <code class="docutils literal notranslate"><span class="pre">N/W</span></code> applies for all properties.</p>
</section>
<section id="calculated-precision">
<h2>Calculated precision<a class="headerlink" href="#calculated-precision" title="Link to this heading">#</a></h2>
<p>The value of <span class="math notranslate nohighlight">\(\rho\)</span> depends on the details of the system and the Monte Carlo method. The method of estimating <span class="math notranslate nohighlight">\(\rho\)</span> introduced by Van de Walle and Asta `` and implemented in <code class="xref py py-class docutils literal notranslate"><span class="pre">BasicStatisticsCalculator</span></code>, calculates <span class="math notranslate nohighlight">\(\hat{\rho}\)</span>, an estimate for <span class="math notranslate nohighlight">\(\rho\)</span>, by searching for the smallest value of <span class="math notranslate nohighlight">\(k\)</span> for which <span class="math notranslate nohighlight">\(\hat{\gamma}_k/\hat{\gamma}_0 \le 1/2\)</span>.</p>
<p>If samples are weighted, as in the n-fold way algorithm, then <code class="xref py py-class docutils literal notranslate"><span class="pre">BasicStatisticsCalculator</span></code> uses one of two optional approaches which re-sample the data to generate <span class="math notranslate nohighlight">\(N'\)</span> equally weighted observations. The weighted observations can be considered a time series, where the time interval associated with each sample value is equal to the sample weight. Then the time series can be sampled at <span class="math notranslate nohighlight">\(N'\)</span> regular intervals. Given the resampled data, the two approaches are:</p>
<ol class="arabic simple">
<li><p>Calculate <span class="math notranslate nohighlight">\(\bar{X} = \sum_l X_l w_l / \sum_l w_l\)</span> and <span class="math notranslate nohighlight">\(\hat{\gamma}_0 = \mathrm{Var}(X)\)</span> directly from the original observations and sample weights, and only calculate <span class="math notranslate nohighlight">\(\hat{\rho}\)</span> from resampled observations</p></li>
<li><p>Calculate <span class="math notranslate nohighlight">\(\bar{X}\)</span>, <span class="math notranslate nohighlight">\(\hat{\gamma}_0\)</span>, and <span class="math notranslate nohighlight">\(\hat{\rho}\)</span> from the resampled observations</p></li>
</ol>
<p>Given <span class="math notranslate nohighlight">\(\hat{\gamma}_0\)</span> and <span class="math notranslate nohighlight">\(\hat{\rho}\)</span>, the error in the mean, <span class="math notranslate nohighlight">\(\bar{X} \pm p\)</span>, is calculated to a user-specified confidence level according to</p>
<div class="math notranslate nohighlight">
\[p = \sqrt{2} * \mathrm{erf}^{-1}(c) \sqrt{ \frac{\hat{\gamma}_0}{N} \left(\frac{1+\hat{\rho}}{1-\hat{\rho}}\right) }\]</div>
<p>where <span class="math notranslate nohighlight">\(c\)</span> is the confidence level, and <span class="math notranslate nohighlight">\(p\)</span> is the calculated precision.</p>
</section>
</section>


                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="overview.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Overview</p>
      </div>
    </a>
    <a class="right-next"
       href="../reference/libcasm/index.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Reference (libcasm)</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <dialog id="pst-secondary-sidebar-modal"></dialog>
                <div id="pst-secondary-sidebar" class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
<div
    id="pst-page-navigation-heading-2"
    class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc" aria-labelledby="pst-page-navigation-heading-2">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#performing-completion-checks">Performing completion checks</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#examples">Examples</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#equilibration-check">Equilibration check</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#calculated-precision">Calculated precision</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      Â© Copyright 2024, CASM Developers.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.2.3.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  <!-- # L10n: Setting the PST URL as an argument as this does not need to be localized -->
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.16.1.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>